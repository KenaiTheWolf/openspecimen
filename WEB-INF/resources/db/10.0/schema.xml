<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet author="vpawar" id="Container status - checked out">
    <addColumn tableName="OS_STORAGE_CONTAINERS">
      <column name="STATUS" type="${text.type}(32)" />
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Container blocked position">
    <addColumn tableName="OS_CONTAINER_POSITIONS">
      <column name="BLOCKED_FOR_CONTAINER_ID" type="${int.type}" />
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Delete duplicate form record entries">
    <sql>
      delete from
        catissue_form_record_entry
      where
        identifier in (
          select
            *
          from (
            select
              ge.identifier
            from
              catissue_form_record_entry ge
              left join catissue_form_record_entry le
                on le.form_ctxt_id = ge.form_ctxt_id and
                   le.object_id = ge.object_id and
                   le.record_id = ge.record_id and
                   le.activity_status = ge.activity_status and
                   ge.identifier > le.identifier
            where
              le.identifier is not null
          ) t
        );
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Create index on form context as it is required to enforce FK constraint" dbms="mysql">
    <createIndex tableName="CATISSUE_FORM_RECORD_ENTRY" indexName="OS_FORM_RECORD_CTXT_IDX">
      <column name="FORM_CTXT_ID" />
    </createIndex>
  </changeSet>

  <changeSet author="vpawar" id="Drop the non-unique index on the form context, record and object tuple">
    <dropIndex tableName="CATISSUE_FORM_RECORD_ENTRY" indexName="OS_FORM_REC_ENTRY_IDX" />
  </changeSet>

  <changeSet author="vpawar" id="Add an unique index on the form context, record and object tuple">
    <createIndex tableName="CATISSUE_FORM_RECORD_ENTRY" indexName="OS_FORM_OBJECT_RECORD_IDX" unique="true">
      <column name="FORM_CTXT_ID" />
      <column name="OBJECT_ID" />
      <column name="RECORD_ID" />
      <column name="ACTIVITY_STATUS" />
    </createIndex>
  </changeSet>

  <changeSet author="vpawar" id="Mark the vital status PV for Dead">
    <sql>
      insert into
        os_pv_props
      select
        pv.identifier as pv_id, 'dead', 'true'
      from
        catissue_permissible_value pv
      where
        pv.public_id = 'vital_status' and
        pv.value = 'Dead' and
        pv.activity_status != 'Disabled'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Setting to disable notifications for the scheduled container tasks">
    <addColumn tableName="OS_SCHED_CONT_ACTIVITIES">
      <column name="DISABLE_REMINDERS" type="${boolean.type}" defaultValueBoolean="false">
        <constraints nullable="false" />
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Enable or disable specimen carts digest notifications">
    <addColumn tableName="CATISSUE_SPECIMENLIST_TAGS">
      <column name="SEND_DIGEST_NOTIFS" type="${boolean.type}" />
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Keep track who added specimens to the cart and when">
    <addColumn tableName="CATISSUE_SPEC_TAG_ITEMS">
      <column name="ADDED_BY" type="${int.type}">
        <constraints foreignKeyName="FK_CART_ITEMS_ADDED_BY" referencedTableName="CATISSUE_USER"
          referencedColumnNames="IDENTIFIER" />
      </column>
      <column name="ADDED_ON" type="${nullable.ts.type}" />
    </addColumn>
  </changeSet>
</databaseChangeLog>